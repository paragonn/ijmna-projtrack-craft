{% if image|length %}
	{% set extension = image.extension|default(image|split('.')|last) %}

	{% set styles = {} %}
	{% set pictureAttrs = {} %}

	{# Alt Text #}
	{% set altText = alt|default(image.title) %}

	{# Image at the highest res we'd need to use #}
	{% set maxResWidth = 2560 %}
	{% set maxResHeight = null %}

	{# Fallback Image #}
	{% set reasonableFallbackWidth = fallbackWidth|default(1280) %}
	{% set reasonableFallbackHeight = null %}

	{# Aspect Ratio #}
	{% if aspectRatio is numeric %}
		{% set maxResHeight = maxResWidth / (aspectRatio) %}
		{% set reasonableFallbackHeight = reasonableFallbackWidth / (aspectRatio) %}
		{% set pictureAttrs = pictureAttrs|merge({
			style: {
				'--aspect-ratio': aspectRatio
			}
		}) %}
	{% endif %}

	{# Focal Point #}
	{% if image.hasFocalPoint %}
		{% set x = image.focalpoint|first * 100 ~ '%' %}
		{% set y = image.focalpoint|last * 100 ~ '%' %}
		{% set styles = styles|merge({'object-position':  x ~ ' ' ~ y}) %}
	{% endif %}

	{# Picture Classes #}
	{% if pictureClasses|length %}
		{% set pictureAttrs = pictureAttrs|merge({
			class: pictureClasses|join(' ')
		}) %}
	{% endif %}

	{% set imgAttrs = {
		width: image.width,
		height: image.height,
		alt: altText,
	} %}
	{% if lazy %}
		{% set imgAttrs = imgAttrs|merge( { loading: 'lazy' } ) %}
	{% endif %}
	{% if class|length %}
		{% set imgAttrs = imgAttrs|merge( { class: class|join(' ') } ) %}
	{% endif %}
	{% if styles|length %}
		{% set imgAttrs = imgAttrs|merge( { style: styles } ) %}
	{% endif %}
	{% if attrs|length %}
		{% set imgAttrs = imgAttrs|merge( attrs, true ) %}
	{% endif %}

	{# Cloudflare Images Configuration - Get original image URL #}
	{% set baseUrl = image.url %}
	{% set cfDomain = getenv('CF_ASSETS_DOMAIN')|default('https://assets.ijmtracker.org') %}
	{% set cfBasePath = cfDomain ~ '/cdn-cgi/image/' %}
	{% set cfParams = [] %}

	{# Add width parameter #}
	{% if maxResWidth %}
		{% set cfParams = cfParams|merge(['width=' ~ maxResWidth]) %}
	{% endif %}

	{# Add height parameter #}
	{% if maxResHeight %}
		{% set cfParams = cfParams|merge(['height=' ~ maxResHeight]) %}
	{% endif %}

	{# Add focal point for gravity #}
	{% if image.hasFocalPoint %}
		{% set x = image.focalPoint | first %}
		{% set y = image.focalPoint | last %}
		{% set cfParams = cfParams|merge(['gravity=' ~ x ~ 'x' ~ y]) %}
	{% endif %}

	{# Add transform mode #}
	{% set cfParams = cfParams|merge(['fit=' ~ (transformMode|default('cover'))]) %}

	{% if extension == "gif" or (not image.extension|default(null)|length and image|split('.')|last  in ["gif"]) %}
		{% set imgAttrs = imgAttrs|merge({ src: baseUrl }) %}
		{{ tag('img', imgAttrs) }}

	{% elseif image.extension|default(null) in ["svg"] or (not image.extension|default(null)|length and image|split('.')|last  in ["svg"]) %}
		{{ svg(image.getVolume().fs.hasMethod('path') ? (image.getVolume().fs.path ~ "/" ~ image.getFolder().path ~ image.filename) : baseUrl) | attr(imgAttrs) }}

	{% elseif not image.extension|default(null)|length and extension == "svg" %}
		{% set imagePath = '@webroot/' ~ image %}
		{{ svg(imagePath) | attr(imgAttrs) }}

	{% else %}
		<picture {{ attr(pictureAttrs) }}>
			{# AVIF Source #}
			{% if craft.app.images.supportsAvif and image.mimeType != 'image/avif' %}
				{% set cfParamsAvif = cfParams|merge(['format=avif']) %}
				{% set cfImageUrl = cfBasePath ~ cfParamsAvif|join(',') ~ '/' ~ baseUrl %}
				{{ tag('source', {
					srcset: cfImageUrl,
					sizes: sizes|join(', '),
					type: 'image/avif',
				}) }}
			{% endif %}

			{# WebP Source #}
			{% if craft.app.images.supportsWebP and image.mimeType != 'image/webp' %}
				{% set cfParamsWebp = cfParams|merge(['format=webp']) %}
				{% set cfImageUrl = cfBasePath ~ cfParamsWebp|join(',') ~ '/' ~ baseUrl %}
				{{ tag('source', {
					srcset: cfImageUrl,
					sizes: sizes|join(', '),
					type: 'image/webp',
				}) }}
			{% else %}
				{# Fallback to auto format #}
				{% set cfParamsAuto = cfParams|merge(['format=auto']) %}
				{% set cfImageUrl = cfBasePath ~ cfParamsAuto|join(',') ~ '/' ~ baseUrl %}
				{{ tag('source', {
					srcset: cfImageUrl,
					sizes: sizes|join(', '),
					type: image.mimeType,
				}) }}
			{% endif %}

			{# Fallback Image #}
			{% set cfParamsFallback = ['width=' ~ reasonableFallbackWidth] %}
			{% if reasonableFallbackHeight %}
				{% set cfParamsFallback = cfParamsFallback|merge(['height=' ~ reasonableFallbackHeight]) %}
			{% endif %}
			{% set cfParamsFallback = cfParamsFallback|merge(['format=auto', 'fit=' ~ (transformMode|default('cover'))]) %}
			{% if image.hasFocalPoint %}
				{% set x = image.focalPoint | first %}
				{% set y = image.focalPoint | last %}
				{% set cfParamsFallback = cfParamsFallback|merge(['gravity=' ~ x ~ 'x' ~ y]) %}
			{% endif %}
			{% set cfImageUrl = cfBasePath ~ cfParamsFallback|join(',') ~ '/' ~ baseUrl %}
			{% set imgAttrs = imgAttrs|merge({ src: cfImageUrl }) %}

			{{ tag('img', imgAttrs) }}
		</picture>
	{% endif %}
{# {% else %}
	<p>No image specified.</p> #}
{% endif %}
