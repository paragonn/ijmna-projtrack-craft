{% if image|length %}

    {% set doWebp = craft.app.config.env != 'dev' and webp %}
    {% set imgWidth = width ? "width = #{width|default(null)}" : null %}
    {% set imgHeight = height ? "height = #{height|default(null)}" : null %}
    {% set extension = image.extension|default(image|split('.')|last) %}

    {% set imageStyles = null %}
    {% if image.hasFocalPoint|default(false) %}
        {% set x = image.focalPoint | first %}
        {% set y = image.focalPoint | last %}
        {% set imageStyles = 'object-position: ' ~ [x * 100 ~ '%', y * 100 ~ '%']|join(' ') %}
    {% endif %}

    {% set attributes = {}
        |merge(id|length ? {id : id} : {})
        |merge(class|length ? {class : class} : {})
        |merge(alpineClass|length ? {":class" : alpineClass} : {})
        |merge(alt|length ? {alt : alt} : {})
        |merge(width|length ? {width : width} : {})
        |merge(height|length ? {height : height} : {})
        |merge(lazy ? {loading: "lazy"} : {})
        |merge(imageStyles|length ? {style: imageStyles} : {})
        |merge(attrs is iterable ? attrs : {})
    %}

    {% set baseUrl = image.getUrl()|default(image) %}
    {% set cfBasePath = '/cdn-cgi/image/' %}
    {% set cfParams = [] %}
    {% if width %}
        {% set cfParams = cfParams|merge(['width=' ~ width]) %}
    {% endif %}
    {% if height %}
        {% set cfParams = cfParams|merge(['height=' ~ height]) %}
    {% endif %}
    {% if image.hasFocalPoint|default(false) %}
        {% set cfParams = cfParams|merge(['gravity=' ~ x ~ 'x' ~ y]) %}
    {% endif %}
    {% if preset %}
        {% set cfParams = cfParams|merge([preset]) %}
    {% endif %}
    {% set cfParams = cfParams|merge(['fit=cover']) %}

    {% if extension == "gif" or (not image.extension|default(null)|length and image|split('.')|last in ["gif"]) %}
        <img src="{{ baseUrl }}" {{ attr(attributes) }}>

    {% elseif image.extension|default(null) in ["svg"] or (not image.extension|default(null)|length and image|split('.')|last in ["svg"]) %}
        {{ svg(image.getVolume().fs.path ~ "/" ~ image.getFolder().path ~ image.filename) | attr({
            fill: fill,
            class: class,
            width: width,
            height: height,
        }| merge(attrs is iterable ? attrs : {})) }}

    {% elseif not image.extension|default(null)|length and extension == "svg" %}
        {% set imagePath = '@webroot/' ~ image %}
        {{ svg(imagePath) | attr({
            fill: fill,
            class: class,
            width: width,
            height: height,
        }| merge(attrs is iterable ? attrs : {})) }}

    {% elseif plainImage %}
        {% set cfParams = cfParams|merge(['format=auto']) %}
        {% set cfImageUrl = cfBasePath ~ cfParams|join(',') ~ '/' ~ baseUrl %}
        <img src="{{ cfImageUrl }}" type="image/jpeg" {{ attr(attributes) }}/>

    {% else %}
        {% set found = false %}
        <picture {% if pictureClass %} class="{{ pictureClass }}"{% endif %}>
            {% if doWebp and extension != "webp" %}
                {% set cfParamsWebp = cfParams|merge(['format=webp']) %}
                {% set cfImageUrl = cfBasePath ~ cfParamsWebp|join(',') ~ '/' ~ baseUrl %}
                {% if addSrcSet %}
                    {% set srcSetWidths = width ? [width * 0.5, width, width * 1.5] : [640, 1280, 1920] %}
                    {% set srcSetItems = [] %}
                    {% for w in srcSetWidths %}
                        {% set cfParamsSrcSet = cfParams|merge(['width=' ~ w, 'format=webp']) %}
                        {% set srcSetItems = srcSetItems|merge(["#{cfBasePath ~ cfParamsSrcSet|join(',') ~ '/' ~ baseUrl} #{w}w"]) %}
                    {% endfor %}
                    <source sizes="100vw" srcset="{{ srcSetItems|join(', ') }}" type="image/webp">
                    {% set found = true %}
                {% else %}
                    <source sizes="100vw" srcset="{{ cfImageUrl }}" type="image/webp">
                    {% set found = true %}
                {% endif %}
            {% endif %}

            {% set cfParamsJpg = cfParams|merge(['format=auto']) %}
            {% set cfImageUrl = cfBasePath ~ cfParamsJpg|join(',') ~ '/' ~ baseUrl %}
            {% if addSrcSet %}
                {% set srcSetWidths = width ? [width * 0.5, width, width * 1.5] : [640, 1280, 1920] %}
                {% set srcSetItems = [] %}
                {% for w in srcSetWidths %}
                    {% set cfParamsSrcSet = cfParams|merge(['width=' ~ w, 'format=auto']) %}
                    {% set srcSetItems = srcSetItems|merge(["#{cfBasePath ~ cfParamsSrcSet|join(',') ~ '/' ~ baseUrl} #{w}w"]) %}
                {% endfor %}
                <source sizes="100vw" srcset="{{ srcSetItems|join(', ') }}" type="image/{{ extension == 'webp' ? extension : 'jpeg' }}">
                {% set found = true %}
            {% else %}
                <source sizes="100vw" srcset="{{ cfImageUrl }}" type="image/{{ extension == 'webp' ? extension : 'jpeg' }}">
                {% set found = true %}
            {% endif %}

            {% if not found %}
                <source sizes="100vw" srcset="{{ baseUrl }}" type="image/{{ extension == 'webp' ? extension : 'jpeg' }}">
            {% endif %}
            {% set cfParamsPlaceholder = ['width=160', 'height=90', 'format=auto'] %}
            <img src="{{ cfBasePath ~ cfParamsPlaceholder|join(',') ~ '/' ~ baseUrl }}" {{ attr(attributes) }} />
        </picture>
    {% endif %}
    
{% endif %}